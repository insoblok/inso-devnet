services:
  # ── Mock L1 (Anvil) ──────────────────────────────────
  l1-node:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil", "--host", "0.0.0.0", "--port", "8551", "--chain-id", "1", "--block-time", "12"]
    ports:
      - "8551:8551"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8551"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ── Sequencer ────────────────────────────────────────
  sequencer:
    build:
      context: ../inso-sequencer
      dockerfile: Dockerfile
    ports:
      - "8545:8545"
      - "8546:8546"
      - "6060:6060"
    volumes:
      - ./config/sequencer.yaml:/etc/inso/config.yaml:ro
    environment:
      - INSO_L1_RPC_URL=http://l1-node:8551
      - BATCH_SUBMITTER_PRIVATE_KEY=${BATCH_SUBMITTER_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
    depends_on:
      l1-node:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ── Validator ────────────────────────────────────────
  validator:
    build:
      context: ../inso-validator
      dockerfile: Dockerfile
    ports:
      - "8547:8547"
      - "30303:30303"
      - "6061:6061"
    volumes:
      - ./config/validator.yaml:/etc/inso/config.yaml:ro
      - validator-data:/data
    environment:
      - INSO_SEQUENCER_URL=http://sequencer:8545
      - INSO_L1_RPC_URL=http://l1-node:8551
      - INSO_VALIDATOR_KEY=${VALIDATOR_PRIVATE_KEY:-0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6}
    depends_on:
      sequencer:
        condition: service_healthy

  # ── Contract Deployer (init container) ───────────────
  contract-deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    working_dir: /contracts
    volumes:
      - ../inso-contracts:/contracts:ro
    environment:
      - DEPLOYER_PRIVATE_KEY=${DEPLOYER_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Deploying InSoBlok contracts to L2 sequencer..."
        forge script script/Deploy.s.sol \
          --rpc-url http://sequencer:8545 \
          --broadcast \
          --private-key $$DEPLOYER_PRIVATE_KEY \
          --skip-simulation || echo "Deploy script completed (may fail if no EVM support yet)"
        echo "Contract deployment finished."
    depends_on:
      sequencer:
        condition: service_healthy

  # ── Explorer ─────────────────────────────────────────
  explorer:
    build:
      context: ../inso-explorer
      dockerfile: Dockerfile
    ports:
      - "3001:80"
    depends_on:
      sequencer:
        condition: service_healthy

  # ── Prometheus ───────────────────────────────────────
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - sequencer
      - validator

  # ── Grafana ──────────────────────────────────────────
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./config/grafana/provisioning/dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
      - ./config/grafana/provisioning/datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  validator-data:
  grafana-data:
